<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>HonoShop â€“ Lista de compras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- SDK de Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <link rel="manifest" href="manifest.json">
  
  <style>
    :root { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: #0f172a; color: #e5e7eb; }
    .app { max-width: 480px; margin: 0 auto; padding: 16px; }
    .card {
      background: rgba(15,23,42,0.95);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
      border: 1px solid rgba(148,163,184,0.3);
    }
    h1 {
      margin: 0 0 4px;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between; /* ðŸ‘ˆ ESTA ES LA CLAVE */
    }
    h1 span.logo-dot { width:10px; height:10px; border-radius:999px; background:#22c55e; box-shadow:0 0 10px #22c55e; }
    .subtitle { margin: 0 0 12px; font-size: 13px; color: #9ca3af; }
    .row { display:flex; gap:8px; margin-bottom:10px; }
    .row input {
      flex:1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      outline: none;
      font-size: 14px;
    }
    .row input::placeholder { color:#6b7280; }
    .row button {
      border-radius: 999px;
      padding: 8px 14px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: white;
      box-shadow: 0 6px 14px rgba(22,163,74,0.45);
      transition: transform 0.07s ease, box-shadow 0.07s ease;
    }
    .row button:active { transform: translateY(1px); box-shadow: 0 3px 8px rgba(22,163,74,0.35); }
    .pill-bar { display:flex; justify-content:space-between; margin-top:6px; font-size:11px; color:#9ca3af; }
    .list { margin-top: 8px; max-height: 360px; overflow-y:auto; padding-right:4px; }
    .item {
      display:flex; align-items:center; justify-content:space-between;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(55,65,81,0.8);
      margin-bottom: 6px;
      font-size: 14px;
    }
    .item-left { display:flex; align-items:center; gap:8px; flex:1; min-width:0; }
    .item-name { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item-qty { font-size:12px; color:#9ca3af; }
    .item.done { opacity:0.6; text-decoration: line-through; }
    .chip { font-size:11px; padding: 2px 8px; border-radius:999px; border:1px solid rgba(148,163,184,0.5); color:#9ca3af; }
    .item-actions { display:flex; align-items:center; gap:6px; margin-left:8px; }
    .btn-icon {
  width:42px;
  height:42px;
  border-radius:999px;
  border:none;
  cursor:pointer;

  display:flex;
  align-items:center;
  justify-content:center;

  font-size:22px;
  font-weight:bold;

  background: rgba(15,23,42,0.95);
  color:#e5e7eb;
  border: 1px solid rgba(75,85,99,0.9);

  transition: background 0.07s ease, transform 0.07s ease;
}
    .btn-icon:active { transform: translateY(1px); background: rgba(30,64,175,0.9); }
    .footer-text { margin-top: 10px; font-size: 11px; color: #6b7280; text-align:right; }
    #debug {
      margin-top: 10px;
      font-size: 11px;
      color: #93c5fd;
      white-space: pre-wrap;
      opacity: 0.9;
    }
  </style>
</head>

<body>
  
  
<p class="subtitle">Tu lista a mano</p>
  <div class="app">
    <div class="card">
      <h1><span class="logo-dot"></span>HonoShop
      <button id="btnAyuda" class="btn-ayuda">Ayuda</button>
      </h1>
      <p class="subtitle">Tu lista a mano</p>

      <div class="row">
        <input id="inputProducto" type="text" placeholder="Ej: leche, pan, detergente..." />
        <button id="btnAgregar" type="button">Agregar</button>
      </div>

      <div class="pill-bar">
        <span id="lblUsuario"></span>
        <span id="lblResumen"></span>
      </div>

      <div id="lista" class="list"></div>

      <pre id="log" style="margin-top:10px;padding:10px;border-radius:12px;background:rgba(0,0,0,0.35);color:#93c5fd;font-size:12px;white-space:pre-wrap;max-height:200px;overflow:auto;"></pre>
     
      <div class="footer-text">Los cambios se sincronizan con tu chat del bot.</div>
      <div id="debug"></div>
    </div>
  </div>

  <script>
  // =========================
  // LOG VISIBLE
  // =========================
  function log(msg) {
    const el = document.getElementById("log");
    if (!el) return;
    el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
  }

  async function safeText(res) {
    try { return await res.text(); } catch { return ""; }
  }

    if (!window.matchMedia('(display-mode: standalone)').matches) {
  if (!localStorage.getItem("honoshop_pwa_hint")) {
    setTimeout(() => {
      alert("ðŸ“Œ Tip: podÃ©s agregar HonoShop a tu pantalla para usarlo como una app");
      localStorage.setItem("honoshop_pwa_hint", "1");
    }, 3000);
  }
}

  // =========================
  // CONFIG
  // =========================
  const API_BASE = "/api/shopping";

  // =========================
  // TELEGRAM INIT + SCOPE
  // =========================
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg) { try { tg.ready(); } catch(e) {} }

  function getWebUserId() {
  let id = localStorage.getItem("honoshop_user");
  if (!id) {
    id = crypto.randomUUID();
    localStorage.setItem("honoshop_user", id);
  }
  return id;
}  

  const init = (tg && tg.initDataUnsafe) ? tg.initDataUnsafe : {};
  const userId = init?.user?.id || getWebUserId();
  const userName = (init?.user?.first_name || init?.user?.username || "Usuario");

  const startParam1 = init?.start_param ? String(init.start_param) : "";
  const u = new URL(window.location.href);
  const startParam2 = u.searchParams.get("tgWebAppStartParam") || "";
  const startParam = startParam1 || startParam2;

  let scope = "user";
  let scopeId = String(userId);

  if (startParam && startParam.startsWith("g_")) {
    scope = "group";
    scopeId = startParam.substring(2);
  }

  if (!scopeId) {
    scope = "user";
    scopeId = String(userId || "");
  }

  function setDebug(msg) {
    const el = document.getElementById("debug");
    if (el) el.textContent = msg;
  }

  // =========================
  // UI
  // =========================
  let items = [];

  function initTelegramUI() {
    const lbl = document.getElementById("lblUsuario");
    if (lbl) lbl.textContent = "Hola, " + userName;

    try {
      if (tg && tg.themeParams && tg.themeParams.bg_color) {
        document.body.style.backgroundColor = tg.themeParams.bg_color;
      }
    } catch(e) {}

    try {
      if (tg && tg.MainButton) {
        tg.MainButton.setText("Cerrar HonoShop");
        tg.MainButton.onClick(function(){ tg.close(); });
        tg.MainButton.show();
      }
    } catch(e) {}
  }

  function renderLista() {
    const cont = document.getElementById("lista");
    if (!cont) return;
    cont.innerHTML = "";

    if (!items || items.length === 0) {
      cont.innerHTML = '<p style="font-size:13px;color:#6b7280;margin-top:4px;">TodavÃ­a no agregaste productos.</p>';
      const res = document.getElementById("lblResumen");
      if (res) res.textContent = "";
      return;
    }

    let total = 0, hechos = 0;

    items.forEach((it, index) => {
      total++;
      if (it.done) hechos++;

      const div = document.createElement("div");
      div.className = "item" + (it.done ? " done" : "");

      const left = document.createElement("div");
      left.className = "item-left";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = !!it.done;
      cb.onchange = () => toggleItem(index);

      const info = document.createElement("div");

      const name = document.createElement("div");
      name.className = "item-name";
      name.textContent = it.name;

      const qty = document.createElement("div");
      qty.className = "item-qty";
      qty.textContent = "x " + it.qty;

      info.appendChild(name);
      info.appendChild(qty);

      left.appendChild(cb);
      left.appendChild(info);

      const actions = document.createElement("div");
      actions.className = "item-actions";

      const chip = document.createElement("span");
      chip.className = "chip";
      chip.textContent = it.source || "MiniApp";

      const btnMinus = document.createElement("button");
      btnMinus.className = "btn-icon";
      btnMinus.textContent = "-";
      btnMinus.onclick = () => cambiarCantidad(index, -1);

      const btnPlus = document.createElement("button");
      btnPlus.className = "btn-icon";
      btnPlus.textContent = "+";
      btnPlus.onclick = () => cambiarCantidad(index, 1);

      const btnDel = document.createElement("button");
      btnDel.className = "btn-icon";
      btnDel.textContent = "Ã—";
      btnDel.onclick = () => eliminarItem(index);

      actions.appendChild(chip);
      actions.appendChild(btnMinus);
      actions.appendChild(btnPlus);
      actions.appendChild(btnDel);

      div.appendChild(left);
      div.appendChild(actions);
      cont.appendChild(div);
    });

    const resumen = document.getElementById("lblResumen");
    if (resumen) resumen.textContent = hechos + "/" + total + " comprados";
  }

  // =========================
  // SERVER CALLS
  // =========================
  async function cargarListaDesdeServidor() {
    try {
      //log("ENTER cargarLista");
      //log("userId=" + userId + " scope=" + scope + " scopeId=" + scopeId);

      if (!userId) {
        //log("ERROR: no hay userId (no es WebApp real).");
        items = [];
        renderLista();
        return;
      }

      const cacheBust = Date.now().toString();
      const url = new URL(API_BASE + "/lista", window.location.origin);
      url.searchParams.set("scope", scope);
      url.searchParams.set("scopeId", scopeId);
      url.searchParams.set("_", cacheBust);

      //log("GET " + url.toString());

      const res = await fetch(url.toString(), { method: "GET", cache: "no-store" });
      //log("RES status=" + res.status);

      if (!res.ok) {
        const t = await safeText(res);
        //log("RES body=" + t.slice(0, 200));
        items = [];
        renderLista();
        return;
      }

      const data = await res.json();
      //log("JSON ok items=" + (Array.isArray(data) ? data.length : "no-array"));

      items = (data || []).map(r => ({
        id: r.id,
        name: r.name,
        qty: Number(r.qty || 1),
        done: !!r.done,
        source: r.source || "MiniApp"
      }));

      renderLista();
      //log("render OK");
    } catch (e) {
      //log("EX: " + (e?.message || e));
      items = [];
      renderLista();
    }
  }

  async function enviarCambioAlServidor(tipo, nombre, extra) {
  if (!userId) return;

  const payload = {
    userId: String(userId),
    tipo: tipo,
    nombre: nombre,
    extra: (extra != null ? String(extra) : null),
    scope: scope,
    scopeId: String(scopeId),
    source: (init?.user ? "MiniApp" : "Web")
  };

  try {
    const res = await fetch(API_BASE + "/sync", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const t = await res.text().catch(() => "");
      setDebug((document.getElementById("debug")?.textContent || "") + "\nSYNC ERROR " + res.status + " " + t);
    }
  } catch (e) {
    setDebug((document.getElementById("debug")?.textContent || "") + "\nSYNC EX " + (e?.message || e));
  }
}

  // =========================
  // ACTIONS
  // =========================
  function agregarItemDesdeInput() {
    const input = document.getElementById("inputProducto");
    const valor = (input.value || "").trim();
    if (!valor) return;

    items.push({ name: valor, qty: 1, done: false, source: "MiniApp" });
    input.value = "";
    renderLista();
    enviarCambioAlServidor("add", valor, null);
  }

  function cambiarCantidad(idx, delta) {
    const it = items[idx];
    if (!it) return;
    it.qty = Math.max(1, (it.qty || 1) + delta);
    renderLista();
    enviarCambioAlServidor("qty", it.name, it.qty);
  }

  function toggleItem(idx) {
    const it = items[idx];
    if (!it) return;
    it.done = !it.done;
    renderLista();
    enviarCambioAlServidor("toggle", it.name, it.done);
  }

  function eliminarItem(idx) {
    const it = items[idx];
    if (!it) return;
    const name = it.name;
    items.splice(idx, 1);
    renderLista();
    enviarCambioAlServidor("delete", name, null);
  }

  

  // =========================
  // START
  // =========================
  window.addEventListener("load", () => {
    const el = document.getElementById("log");
    //if (el) el.textContent = "LOG OK: script cargÃ³\n";

    initTelegramUI();

    document.getElementById("btnAgregar").addEventListener("click", agregarItemDesdeInput);
    document.getElementById("inputProducto").addEventListener("keydown", (e) => {
      if (e.key === "Enter") agregarItemDesdeInput();
    });

    (function () {
    const btnAyuda = document.getElementById("btnAyuda");
    if (!btnAyuda) return;

    if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe?.user) {
      btnAyuda.style.display = "none";
    }
  })();

  // AcciÃ³n del botÃ³n Ayuda (solo web)
  document.getElementById("btnAyuda")?.addEventListener("click", () => {
    alert(
      "HonoShop tambiÃ©n funciona en Telegram.\n\n" +
      "â€¢ AcÃ¡ lo usÃ¡s como lista personal\n" +
      "â€¢ En Telegram funciona mejor en grupos\n" +
      "â€¢ Ideal para compras compartidas\n\n" +
      "BuscÃ¡ el bot y agregalo a un grupo."
    );
  });


    // Tip para instalar HonoShop como app (solo mÃ³vil, solo una vez)
(function () {
  // No mostrar en Telegram
  if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe?.user) return;

  // No mostrar en PC
  if (window.innerWidth > 768) return;

  // No mostrar si ya estÃ¡ instalada
  if (window.matchMedia('(display-mode: standalone)').matches) return;

  // No repetir el mensaje
  if (localStorage.getItem("honoshop_install_tip")) return;

  setTimeout(() => {
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);

    alert(
      isIOS
        ? "ðŸ“Œ Tip: tocÃ¡ Compartir y luego 'Agregar a pantalla de inicio' para usar HonoShop como app."
        : "ðŸ“Œ Tip: podÃ©s agregar HonoShop a tu pantalla y usarlo como una app."
    );

    localStorage.setItem("honoshop_install_tip", "1");
  }, 3000);
})();
    

 

    // Llamo 2 veces por timing/cachÃ© de webview
    setTimeout(() => { cargarListaDesdeServidor(); }, 200);
    setTimeout(() => { cargarListaDesdeServidor(); }, 900);
  });
</script>
  
</body>
</html>




























































