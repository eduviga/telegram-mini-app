<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<title>HonoShop â€“ Lista de compras</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="manifest" href="manifest.json">

<style>
:root { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
* { box-sizing: border-box; }
body { margin: 0; background: #0f172a; color: #e5e7eb; }
.app { max-width: 480px; margin: 0 auto; padding: 16px; }
.card {
  background: rgba(15,23,42,0.95);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.4);
  border: 1px solid rgba(148,163,184,0.3);
}
h1 { margin:0 0 4px; font-size:20px; display:flex; align-items:center; gap:8px; }
.logo-dot { width:10px;height:10px;border-radius:999px;background:#22c55e;box-shadow:0 0 10px #22c55e; }
.subtitle { margin:0 0 12px; font-size:13px; color:#9ca3af; }
.row { display:flex; gap:8px; margin-bottom:12px; align-items:center; }
.row input {
  flex:1;padding:8px 10px;border-radius:999px;
  border:1px solid rgba(148,163,184,0.4);
  background:rgba(15,23,42,0.9);color:#e5e7eb;font-size:14px;
}
.row button {
  padding:8px 14px;border-radius:999px;border:none;
  font-size:14px;cursor:pointer;
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:white;
}
.select-lista {
  flex:1;
  appearance:none;
  background:rgba(15,23,42,0.9);
  color:#e5e7eb;
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.4);
  padding:8px 14px;
}
.btn-icon {
  width:42px;height:42px;border-radius:999px;
  display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:white;border:none;cursor:pointer;font-size:18px;
}
.item {
  display:flex;justify-content:space-between;align-items:center;
  padding:8px 10px;border-radius:10px;
  background:rgba(15,23,42,0.8);
  border:1px solid rgba(55,65,81,0.8);
  margin-bottom:6px;
}
.item-left { display:flex;flex-direction:column;gap:4px; }
.item-actions { display:flex;gap:6px; }
.item-actions .btn-icon {
  min-width:44px;height:34px;padding:0 14px;font-size:18px;
}

/* MODAL */
#customModal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  backdrop-filter:blur(4px);
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.modal-box{
  background:#0f172a;
  padding:20px;
  border-radius:16px;
  width:90%;
  max-width:400px;
  border:1px solid rgba(148,163,184,0.3);
}
.modal-buttons{
  display:flex;
  justify-content:flex-end;
  gap:8px;
  margin-top:12px;
}
</style>
</head>



<body>

<div class="app">
<div class="card">

<h1><span class="logo-dot"></span>HonoShop</h1>
<p class="subtitle">Listas personales y compartidas</p>

<div class="row">
  <select id="selectLista" class="select-lista"></select>
  <button id="btnNuevaLista" class="btn-icon">ï¼‹</button>
  <button id="btnEditarLista" class="btn-icon">âœŽ</button>
  <button id="btnEliminarLista" class="btn-icon">ðŸ—‘</button>
  <button id="btnSalirGrupo" class="btn-icon" style="display:none;background:#dc2626;">â‡¦</button>
</div>

<div class="row">
  <input id="inputProducto" placeholder="Ej: leche, pan..."/>
  <button id="btnAgregar">Agregar</button>
</div>

<div id="lista"></div>

</div>
</div>

<!-- MODAL -->
<div id="customModal">
  <div class="modal-box">
    <div id="modalMessage"></div>
    <input id="modalInput" style="display:none;width:100%;padding:8px;margin-top:10px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:white;" />
    <div class="modal-buttons">
      <button id="modalCancel">Cancelar</button>
      <button id="modalOk">Aceptar</button>
    </div>
  </div>
</div>

<script>
const API_BASE="/api/shopping";

/* ===== MODAL ===== */
function mostrarModal({mensaje,tipo="alert",valorInicial=""}){
  return new Promise(resolve=>{
    const modal=document.getElementById("customModal");
    const msg=document.getElementById("modalMessage");
    const input=document.getElementById("modalInput");
    const ok=document.getElementById("modalOk");
    const cancel=document.getElementById("modalCancel");

    msg.innerHTML=mensaje;
    modal.style.display="flex";

    if(tipo==="prompt"){
      input.style.display="block";
      input.value=valorInicial;
      input.focus();
    } else {
      input.style.display="none";
    }

    cancel.style.display=(tipo==="alert")?"none":"inline-block";

    ok.onclick=()=>{
      modal.style.display="none";
      resolve(tipo==="prompt"?input.value:true);
    };

    cancel.onclick=()=>{
      modal.style.display="none";
      resolve(false);
    };
  });
}

const customAlert=(m)=>mostrarModal({mensaje:m});
const customConfirm=(m)=>mostrarModal({mensaje:m,tipo:"confirm"});
const customPrompt=(m,v="")=>mostrarModal({mensaje:m,tipo:"prompt",valorInicial:v});

/* ===== TU LOGICA ORIGINAL ===== */

function getUserId(){
  let id=localStorage.getItem("honoshop_user");
  if(!id){ id=crypto.randomUUID(); localStorage.setItem("honoshop_user",id); }
  return id;
}

const userId=getUserId();
let scope="user";
let scopeId=userId;
let currentList="General";
let listas=[];
let items=[];

/* SELECTOR */
async function cargarSelector(){
  const select=document.getElementById("selectLista");
  select.innerHTML="";

  const guardadas=JSON.parse(localStorage.getItem("honoshop_listas")||"[]");
  listas=guardadas.length?guardadas:["General"];
  if(!listas.includes("General")) listas.unshift("General");

  listas.forEach(l=>{
    const opt=document.createElement("option");
    opt.value="P-"+l;
    opt.textContent=l;
    select.appendChild(opt);
  });

  try{
    const res=await fetch(`${API_BASE}/my-groups?userId=${userId}`);
    const data=await res.json();
    if(data.ok){
      data.groups.forEach(g=>{
        const opt=document.createElement("option");
        opt.value="G-"+g.id;
        opt.textContent="G-"+g.name;
        select.appendChild(opt);
      });
    }
  }catch(e){}

  const last=localStorage.getItem("honoshop_scope")||"P-General";
  select.value=last;
  aplicarScope(last);
}

/* CONTEXTO */
function aplicarScope(valor){
  localStorage.setItem("honoshop_scope",valor);

  const btnNueva=document.getElementById("btnNuevaLista");
  const btnEditar=document.getElementById("btnEditarLista");
  const btnEliminar=document.getElementById("btnEliminarLista");
  const btnSalir=document.getElementById("btnSalirGrupo");

  if(valor.startsWith("G-")){
    scope="group";
    scopeId=valor.replace("G-","");
    currentList="general";
    btnNueva.style.display="none";
    btnEliminar.style.display="none";
    btnEditar.style.display="";
    btnSalir.style.display="";
  } else {
    scope="user";
    scopeId=userId;
    currentList=valor.replace("P-","");
    localStorage.setItem("honoshop_lista_actual",currentList);
    btnNueva.style.display="";
    btnEditar.style.display="";
    btnEliminar.style.display="";
    btnSalir.style.display="none";
  }

  cargarListaDesdeServidor();
}

/* RENDER */
function render(){
  const cont=document.getElementById("lista");
  cont.innerHTML="";
  if(!items.length){
    cont.innerHTML=`<p style="font-size:13px;color:#6b7280">Sin productos.</p>`;
    return;
  }

  items.forEach(it=>{
    const div=document.createElement("div");
    div.className="item";

    const left=document.createElement("div");
    left.className="item-left";
    left.innerHTML=`
      <div style="display:flex;gap:8px;align-items:center;">
        <input type="checkbox" ${it.done?"checked":""}/>
        <div>${it.name}</div>
      </div>
      <div style="font-size:12px;color:#9ca3af;">x ${it.qty}</div>
    `;

    const actions=document.createElement("div");
    actions.className="item-actions";

    const menos=document.createElement("button");
    menos.className="btn-icon";
    menos.textContent="âˆ’";
    menos.onclick=async()=>{
      await enviar("qty",it.name,String(Math.max(1,it.qty-1)));
      cargarListaDesdeServidor();
    };

    const mas=document.createElement("button");
    mas.className="btn-icon";
    mas.textContent="+";
    mas.onclick=async()=>{
      await enviar("qty",it.name,String(it.qty+1));
      cargarListaDesdeServidor();
    };

    const del=document.createElement("button");
    del.className="btn-icon";
    del.textContent="Ã—";
    del.onclick=async()=>{
      await enviar("delete",it.name);
      cargarListaDesdeServidor();
    };

    actions.append(menos,mas,del);
    div.append(left,actions);
    cont.appendChild(div);
  });
}

/* BACKEND */
async function cargarListaDesdeServidor(){
  const url=new URL(API_BASE+"/lista",location.origin);
  url.searchParams.set("scope",scope);
  url.searchParams.set("scopeId",scopeId);
  url.searchParams.set("list",currentList);

  const res=await fetch(url);
  if(!res.ok) return;
  items=await res.json();
  render();
}

async function enviar(tipo,nombre,extra=null){
  await fetch(API_BASE+"/sync",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      userId,
      tipo,
      nombre,
      extra,
      scope,
      scopeId,
      list:currentList,
      source:"Web"
    })
  });
}

/* EVENTOS */

document.getElementById("selectLista").onchange=e=>{
  aplicarScope(e.target.value);
};

document.getElementById("btnAgregar").onclick=async()=>{
  const input=document.getElementById("inputProducto");
  const nombre=input.value.trim();
  if(!nombre) return;
  await enviar("add",nombre);
  input.value="";
  cargarListaDesdeServidor();
};

document.getElementById("btnNuevaLista").onclick=async function(){
  const tipo=await customPrompt("EscribÃ­:<br><br>1 â†’ Crear lista personal<br>2 â†’ Crear grupo compartido");
  if(!tipo) return;

  if(tipo==="1"){
    const nombre=await customPrompt("Nombre de la nueva lista:");
    if(!nombre) return;
    const clean=nombre.trim();
    if(!clean||listas.includes(clean)) return;
    listas.push(clean);
    localStorage.setItem("honoshop_listas",JSON.stringify(listas));
    aplicarScope("P-"+clean);
    await cargarSelector();
    return;
  }

  if(tipo==="2"){
    const nombre=await customPrompt("Nombre del grupo:");
    if(!nombre) return;
    const clean=nombre.trim();
    if(!clean) return;

    const res=await fetch(API_BASE+"/create-group",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({userId:userId,name:clean})
    });

    const data=await res.json();
    if(!data.ok){
      await customAlert("Error creando grupo");
      return;
    }

    const groupId=data.groupId;
    localStorage.setItem("honoshop_scope","G-"+groupId);
    await cargarSelector();
  }
};

document.getElementById("btnEditarLista").onclick=async()=>{
  if(scope==="group"){
    const nuevo=await customPrompt("Nuevo nombre del grupo:");
    if(!nuevo) return;
    const clean=nuevo.trim();
    if(!clean) return;
    await fetch(API_BASE+"/rename-group",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({groupId:scopeId,name:clean})
    });
    await cargarSelector();
    return;
  }

  if(currentList==="General"){
    await customAlert("No se puede renombrar General.");
    return;
  }

  const nuevo=await customPrompt("Nuevo nombre:",currentList);
  if(!nuevo) return;
  const clean=nuevo.trim();
  if(!clean||listas.includes(clean)) return;

  const index=listas.indexOf(currentList);
  listas[index]=clean;
  localStorage.setItem("honoshop_listas",JSON.stringify(listas));
  aplicarScope("P-"+clean);
  await cargarSelector();
};

document.getElementById("btnEliminarLista").onclick=async()=>{
  if(currentList==="General"){
    await customAlert("No se puede eliminar General.");
    return;
  }
  if(!(await customConfirm(`Eliminar "${currentList}"?`))) return;
  listas=listas.filter(l=>l!==currentList);
  localStorage.setItem("honoshop_listas",JSON.stringify(listas));
  aplicarScope("P-General");
  cargarSelector();
};

document.getElementById("btnSalirGrupo").onclick=async()=>{
  if(!(await customConfirm("Â¿Salir de este grupo?"))) return;
  await fetch(API_BASE+"/leave-group",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({userId:userId,groupId:scopeId})
  });
  localStorage.setItem("honoshop_scope","P-General");
  await cargarSelector();
};

window.onload=async()=>{
  await cargarSelector();
  cargarListaDesdeServidor();
};

const APP_VERSION = "1.0.6";

async function checkVersion() {
  try {
    const res = await fetch("/version.json?t=" + Date.now());
    const data = await res.json();

    if (data.version !== APP_VERSION) {
      const actualizar = await customConfirm(
        "Hay una nueva versiÃ³n disponible.<br><br>Â¿Actualizar ahora?"
      );

      if (actualizar) {
        window.location.href = window.location.href.split("?")[0] + "?v=" + Date.now();
      }
    }
  } catch (e) {}
}

setTimeout(checkVersion, 1500);  
</script>

</body>
</html>









