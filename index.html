<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>HonoShop â€“ Lista de compras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="manifest" href="manifest.json">

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: #0f172a;
      color: #e5e7eb;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }

    .card {
      background: rgba(15,23,42,0.95);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
      border: 1px solid rgba(148,163,184,0.3);
    }

    h1 {
      margin: 0 0 4px;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px #22c55e;
    }

    .subtitle {
      margin: 0 0 12px;
      font-size: 13px;
      color: #9ca3af;
    }

    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      align-items: center;
    }

    .row input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 14px;
    }

    .row input::placeholder {
      color: #6b7280;
    }

    .row button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: white;
      box-shadow: 0 6px 14px rgba(22,163,74,0.45);
    }

    .select-lista {
      flex: 1;
      appearance: none;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 8px 36px 8px 14px;
      font-size: 14px;
      background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 10px center;
    }

    /* Botones de iconos (listas) */
    .btn-icon {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(22,163,74,0.45);
      font-size: 18px;
      line-height: 1;
    }

    /* Modales */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal.hidden {
      display: none;
    }

    .modal-box {
      background: #0f172a;
      color: #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      width: 90%;
      max-width: 320px;
      text-align: center;
    }

    .modal-box h2 {
      margin-top: 0;
      font-size: 18px;
    }

    .modal-box p {
      font-size: 14px;
      color: #cbd5f5;
      white-space: pre-line;
    }

    .modal-box button {
      margin-top: 16px;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #052e16;
      cursor: pointer;
    }

    #lista .item {
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  justify-content: space-between !important;
}

#lista .item-actions {
  display: flex !important;
  flex-direction: row !important;
  align-items: center !important;
  gap: 6px !important;
}

#lista .item-actions button {
  flex: 0 0 auto !important;
}
  </style>
</head>

<body>

  <!-- MODAL AYUDA -->
  <div id="modalAyuda" class="modal hidden">
    <div class="modal-box">
      <h2>Ayuda Â· HonoShop</h2>
      <p id="modalTexto"></p>
      <button id="btnCerrarModal">Entendido</button>
    </div>
  </div>

  <!-- MODAL LISTA (AGREGAR / EDITAR) -->
  <div id="modalLista" class="modal hidden">
    <div class="modal-box">
      <h2 id="tituloModalLista">Agregar lista</h2>
      <input
        id="inputNombreLista"
        type="text"
        placeholder="Ej: FerreterÃ­a"
        style="width:100%;padding:10px;border-radius:10px;border:1px solid #334155;background:#020617;color:#e5e7eb;"
      />
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="btnCancelarLista" style="background:#334155;color:#e5e7eb;">Cancelar</button>
        <button id="btnAceptarLista">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- MODAL ELIMINAR LISTA -->
  <div id="modalEliminarLista" class="modal hidden">
    <div class="modal-box">
      <h2>Eliminar lista</h2>
      <p id="textoEliminarLista"></p>
      <div style="display:flex;gap:10px;justify-content:flex-end;">
        <button id="btnCancelarEliminar" style="background:#334155;color:#e5e7eb;">Cancelar</button>
        <button id="btnConfirmarEliminar" style="background:#dc2626;color:white;">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="app">
    <div class="card">

      <h1>
        <span class="logo-dot"></span>
        HonoShop
      </h1>

      <p class="subtitle">Tu lista a mano</p>

      <!-- FILA LISTAS -->
      <div class="row">
        <select id="selectLista" class="select-lista">
          <option value="General">General</option>
        </select>

        <button id="btnNuevaLista" class="btn-icon" title="Agregar lista">ï¼‹</button>
        <button id="btnEditarLista" class="btn-icon" title="Editar lista">âœŽ</button>
        <button id="btnEliminarLista" class="btn-icon" title="Eliminar lista">ðŸ—‘</button>
      </div>

      <!-- FILA AGREGAR ITEM -->
      <div class="row">
        <input id="inputProducto" type="text" placeholder="Ej: leche, pan, detergente..." />
        <button id="btnAgregar">Agregar</button>
      </div>

      <!-- LISTA -->
      <div id="lista"></div>

    </div>
  </div>

 <script>
/* =========================
   CONFIG + UTILIDADES
========================= */
const API_BASE = "/api/shopping";

function safeText(res) {
  try { return res.text(); } catch { return ""; }
}

function getWebUserId() {
  let id = localStorage.getItem("honoshop_user");
  if (!id) {
    id = crypto.randomUUID();
    localStorage.setItem("honoshop_user", id);
  }
  return id;
}

   function cerrarTodosLosModales() {
  document.querySelectorAll(".modal").forEach(m => {
    m.classList.add("hidden");
  });
}

/* =========================
   TELEGRAM INIT
========================= */
const tg = window.Telegram?.WebApp || null;
if (tg) { try { tg.ready(); } catch {} }

const init = tg?.initDataUnsafe || {};
const userId = init?.user?.id || getWebUserId();
const userName = init?.user?.first_name || "";

let scope = "user";
let scopeId = String(userId);

/* =========================
   LISTAS
========================= */
let listas = [];
let currentList = "General";
let items = [];

function cargarListas() {
  const guardadas = JSON.parse(localStorage.getItem("honoshop_listas") || "[]");
  listas = guardadas.length ? guardadas : ["General"];
  if (!listas.includes("General")) listas.unshift("General");

  const select = document.getElementById("selectLista");
  select.innerHTML = "";

  listas.forEach(l => {
    const opt = document.createElement("option");
    opt.value = l;
    opt.textContent = l;
    select.appendChild(opt);
  });

  const last = localStorage.getItem("honoshop_lista_actual");
  currentList = listas.includes(last) ? last : "General";
  select.value = currentList;
}

/* =========================
   UI
========================= */
function renderLista() {
  const cont = document.getElementById("lista");
  cont.innerHTML = "";

  if (!items.length) {
    cont.innerHTML =
      `<p style="font-size:13px;color:#6b7280">TodavÃ­a no agregaste productos.</p>`;
    return;
  }

  items.forEach((it) => {
    const div = document.createElement("div");
    div.className = "item" + (it.done ? " done" : "");

    const left = document.createElement("div");
    left.className = "item-left";

    const chk = document.createElement("input");
    chk.type = "checkbox";
    chk.checked = !!it.done;
    chk.addEventListener("change", async () => {
      await enviarCambio("done", it.name, { done: chk.checked });
      cargarListaDesdeServidor();
    });

    const txt = document.createElement("div");

    const name = document.createElement("div");
    name.className = "item-name";
    name.textContent = it.name;

    const qty = document.createElement("div");
    qty.className = "item-qty";
    qty.textContent = "x " + it.qty;

    txt.appendChild(name);
    txt.appendChild(qty);

    left.appendChild(chk);
    left.appendChild(txt);

    const actions = document.createElement("div");
    actions.className = "item-actions";

    const btnMenos = document.createElement("button");
    btnMenos.className = "btn-icon";
    btnMenos.textContent = "âˆ’";
    btnMenos.addEventListener("click", async () => {
      await enviarCambio("qty", it.name, { delta: -1 });
      cargarListaDesdeServidor();
    });

    const btnMas = document.createElement("button");
    btnMas.className = "btn-icon";
    btnMas.textContent = "+";
    btnMas.addEventListener("click", async () => {
      await enviarCambio("qty", it.name, { delta: +1 });
      cargarListaDesdeServidor();
    });

    const btnEliminar = document.createElement("button");
    btnEliminar.className = "btn-icon";
    btnEliminar.textContent = "Ã—";
    btnEliminar.addEventListener("click", async () => {
      await enviarCambio("del", it.name);
      cargarListaDesdeServidor();
    });

    actions.appendChild(btnMenos);
    actions.appendChild(btnMas);
    actions.appendChild(btnEliminar);

    div.appendChild(left);
    div.appendChild(actions);

    cont.appendChild(div);
  });
}
/* =========================
   SERVER
========================= */
async function cargarListaDesdeServidor() {
  const url = new URL(API_BASE + "/lista", location.origin);
  url.searchParams.set("scope", scope);
  url.searchParams.set("scopeId", scopeId);
  url.searchParams.set("list", currentList);

  const res = await fetch(url);
  if (!res.ok) return;

  const data = await res.json();
  items = data || [];
  renderLista();
}

async function enviarCambio(tipo, nombre, extra=null) {
  await fetch(API_BASE + "/sync", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId,
      tipo,
      nombre,
      extra,
      scope,
      scopeId,
      list: currentList,
      source: init?.user ? "MiniApp" : "Web"
    })
  });
}

/* =========================
   MODAL LISTA (ÃšNICO)
========================= */
const modalLista = document.getElementById("modalLista");
const inputNombreLista = document.getElementById("inputNombreLista");
const btnCancelarLista = document.getElementById("btnCancelarLista");
const btnAceptarLista = document.getElementById("btnAceptarLista");
const tituloModalLista = document.getElementById("tituloModalLista");
const btnEditarLista = document.getElementById("btnEditarLista");   
const btnAgregar = document.getElementById("btnAgregar");
const inputProducto = document.getElementById("inputProducto");
const btnEliminarLista = document.getElementById("btnEliminarLista");
const modalEliminarLista = document.getElementById("modalEliminarLista");
const textoEliminarLista = document.getElementById("textoEliminarLista");
const btnConfirmarEliminar = document.getElementById("btnConfirmarEliminar");
const btnCancelarEliminar = document.getElementById("btnCancelarEliminar");

let modoLista = "crear";
let listaOriginal = null;

btnNuevaLista.addEventListener("click", () => {
  modoLista = "crear";
  listaOriginal = null;

  tituloModalLista.textContent = "Agregar lista";
  inputNombreLista.value = "";

  modalLista.classList.remove("hidden");
  inputNombreLista.focus();
});

btnCancelarLista.addEventListener("click", () => {
  modalLista.classList.add("hidden");
  inputNombreLista.value = "";
});

btnConfirmarEliminar.addEventListener("click", () => {
  listas = listas.filter(l => l !== currentList);
  localStorage.setItem("honoshop_listas", JSON.stringify(listas));

  currentList = "General";
  localStorage.setItem("honoshop_lista_actual", currentList);

  modalEliminarLista.classList.add("hidden");

  cargarListas();
  cargarListaDesdeServidor();
});   

btnAgregar.addEventListener("click", async () => {
  const nombre = inputProducto.value.trim();
  if (!nombre) return;

  await enviarCambio("add", nombre);
  inputProducto.value = "";

  cargarListaDesdeServidor();
});   

btnEditarLista.addEventListener("click", () => {
  abrirRenombrarLista();
});   

btnCancelarEliminar.addEventListener("click", () => {
  modalEliminarLista.classList.add("hidden");
});   

btnAceptarLista.addEventListener("click", () => {
  const nombre = inputNombreLista.value.trim();
  if (!nombre) return;

  // Evitar duplicados
  if (listas.includes(nombre)) {
    alert("Ya existe una lista con ese nombre");
    return;
  }

  if (modoLista === "crear") {
    listas.push(nombre);
    localStorage.setItem("honoshop_lista_actual", nombre);

  } else if (modoLista === "renombrar") {
    const index = listas.indexOf(listaOriginal);
    if (index === -1) return;

    listas[index] = nombre;

    // actualizar lista actual si corresponde
    if (currentList === listaOriginal) {
      localStorage.setItem("honoshop_lista_actual", nombre);
    }
  }

  localStorage.setItem("honoshop_listas", JSON.stringify(listas));

  modalLista.classList.add("hidden");
  inputNombreLista.value = "";

  cargarListas();
  cargarListaDesdeServidor();
});

  btnEliminarLista.addEventListener("click", () => {
  if (currentList === "General") {
    alert("La lista General no se puede eliminar");
    return;
  }

  if (listas.length <= 1) {
    alert("Debe existir al menos una lista");
    return;
  }

  cerrarTodosLosModales();

  textoEliminarLista.textContent =
    `Â¿Eliminar la lista "${currentList}"?\n\nSe borrarÃ¡n todos sus Ã­tems.`;

  modalEliminarLista.classList.remove("hidden");
});

   function abrirRenombrarLista() {
  if (currentList === "General") {
    alert("La lista General no se puede renombrar");
    return;
  }

  modoLista = "renombrar";
  listaOriginal = currentList;

  tituloModalLista.textContent = "Renombrar lista";
  inputNombreLista.value = currentList;

  modalLista.classList.remove("hidden");
  inputNombreLista.focus();
}

/* =========================
   START
========================= */
window.addEventListener("load", () => {
  if (userName) document.getElementById("lblUsuario").textContent = "Hola, " + userName;

  cargarListas();
  cargarListaDesdeServidor();

  document.getElementById("selectLista").addEventListener("change", e => {
    currentList = e.target.value;
    localStorage.setItem("honoshop_lista_actual", currentList);
    cargarListaDesdeServidor();
  });
});
</script>
  
</body>
</html>






























































































