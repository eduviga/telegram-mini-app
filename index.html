<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>HonoShop â€“ Lista de compras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- SDK de Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: #0f172a; color: #e5e7eb; }
    .app { max-width: 480px; margin: 0 auto; padding: 16px; }
    .card {
      background: rgba(15,23,42,0.95);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
      border: 1px solid rgba(148,163,184,0.3);
    }
    h1 { margin: 0 0 4px; font-size: 20px; display:flex; align-items:center; gap:8px; }
    h1 span.logo-dot { width:10px; height:10px; border-radius:999px; background:#22c55e; box-shadow:0 0 10px #22c55e; }
    .subtitle { margin: 0 0 12px; font-size: 13px; color: #9ca3af; }
    .row { display:flex; gap:8px; margin-bottom:10px; }
    .row input {
      flex:1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      outline: none;
      font-size: 14px;
    }
    .row input::placeholder { color:#6b7280; }
    .row button {
      border-radius: 999px;
      padding: 8px 14px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: white;
      box-shadow: 0 6px 14px rgba(22,163,74,0.45);
      transition: transform 0.07s ease, box-shadow 0.07s ease;
    }
    .row button:active { transform: translateY(1px); box-shadow: 0 3px 8px rgba(22,163,74,0.35); }
    .pill-bar { display:flex; justify-content:space-between; margin-top:6px; font-size:11px; color:#9ca3af; }
    .list { margin-top: 8px; max-height: 360px; overflow-y:auto; padding-right:4px; }
    .item {
      display:flex; align-items:center; justify-content:space-between;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(55,65,81,0.8);
      margin-bottom: 6px;
      font-size: 14px;
    }
    .item-left { display:flex; align-items:center; gap:8px; flex:1; min-width:0; }
    .item-name { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item-qty { font-size:12px; color:#9ca3af; }
    .item.done { opacity:0.6; text-decoration: line-through; }
    .chip { font-size:11px; padding: 2px 8px; border-radius:999px; border:1px solid rgba(148,163,184,0.5); color:#9ca3af; }
    .item-actions { display:flex; align-items:center; gap:6px; margin-left:8px; }
    .btn-icon {
      width:26px; height:26px; border-radius:999px; border:none; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:14px;
      background: rgba(15,23,42,0.9);
      color:#e5e7eb;
      border: 1px solid rgba(75,85,99,0.9);
      transition: background 0.07s ease, transform 0.07s ease;
    }
    .btn-icon:active { transform: translateY(1px); background: rgba(30,64,175,0.9); }
    .footer-text { margin-top: 10px; font-size: 11px; color: #6b7280; text-align:right; }
    #debug {
      margin-top: 10px;
      font-size: 11px;
      color: #93c5fd;
      white-space: pre-wrap;
      opacity: 0.9;
    }
  </style>
</head>

<body>
  <pre id="log" style="margin-top:10px;padding:10px;border-radius:12px;background:rgba(0,0,0,0.35);color:#93c5fd;font-size:12px;white-space:pre-wrap;max-height:200px;overflow:auto;"></pre>
  <div class="app">
    <div class="card">
      <h1><span class="logo-dot"></span>HonoShop</h1>
      <p class="subtitle">Tu lista de compras conectada al bot de Telegram ðŸ›’</p>

      <div class="row">
        <input id="inputProducto" type="text" placeholder="Ej: leche, pan, detergente..." />
        <button id="btnAgregar" type="button">Agregar</button>
      </div>

      <div class="pill-bar">
        <span id="lblUsuario"></span>
        <span id="lblResumen"></span>
      </div>

      <div id="lista" class="list"></div>

      <div class="footer-text">Los cambios se sincronizan con tu chat del bot.</div>
      <div id="debug"></div>
    </div>
  </div>

  <script>
    function log(msg) {
      const el = document.getElementById("log");
      const line = `[${new Date().toLocaleTimeString()}] ${msg}\n`;
      if (el) el.textContent = (el.textContent || "") + line;
      }
      
      async function safeText(res) {
        try { return await res.text(); } catch { return ""; }
      }
    // =========================
    // CONFIG
    // =========================
    // En Cloudflare Pages/Workers: ideal es usar relativo
    const API_BASE = "/api/shopping";
    // Si querÃ©s hardcodear:
    // const API_BASE = "https://telegram-mini-app-e1o.pages.dev/api/shopping";

    // =========================
    // TELEGRAM INIT + SCOPE
    // =========================
    const tg = window.Telegram?.WebApp;
    tg?.ready();
    
    const init = tg?.initDataUnsafe || {};
    const userId = init?.user?.id || 0;
    
    // 1) start_param (forma oficial)
    const startParam1 = init?.start_param ? String(init.start_param) : "";
    
    // 2) tgWebAppStartParam (query que Telegram agrega)
    const u = new URL(window.location.href);
    const startParam2 = u.searchParams.get("tgWebAppStartParam") || "";
    
    // elegimos el que exista
    const startParam = startParam1 || startParam2;
    
    let scope = "user";
    let scopeId = String(userId);
    
    if (startParam && startParam.startsWith("g_")) {
      scope = "group";
      scopeId = startParam.substring(2); // chatId del grupo
    }

    // Safety fallback
    if (!scopeId || scopeId.length === 0) {
      scope = "user";
      scopeId = String(userId || "");
    }

    function setDebug(msg) {
      const el = document.getElementById("debug");
      if (el) el.textContent = msg;
    }

    // =========================
    // UI STATE
    // =========================
    let items = [];

    function initTelegramUI() {
      document.getElementById("lblUsuario").textContent = "Hola, " + userName;

      // tema Telegram
      try {
        if (tg && tg.themeParams && tg.themeParams.bg_color) {
          document.body.style.backgroundColor = tg.themeParams.bg_color;
        }
      } catch(e) {}

      // main button close
      try {
        if (tg && tg.MainButton) {
          tg.MainButton.setText("Cerrar HonoShop");
          tg.MainButton.onClick(function(){ tg.close(); });
          tg.MainButton.show();
        }
      } catch(e) {}
    }

    function renderLista() {
      const cont = document.getElementById("lista");
      cont.innerHTML = "";

      if (!items || items.length === 0) {
        cont.innerHTML = '<p style="font-size:13px;color:#6b7280;margin-top:4px;">TodavÃ­a no agregaste productos.</p>';
        document.getElementById("lblResumen").textContent = "";
        return;
      }

      let total = 0, hechos = 0;

      items.forEach((it, index) => {
        total++;
        if (it.done) hechos++;

        const div = document.createElement("div");
        div.className = "item" + (it.done ? " done" : "");

        const left = document.createElement("div");
        left.className = "item-left";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!it.done;
        cb.onchange = () => toggleItem(index);

        const info = document.createElement("div");

        const name = document.createElement("div");
        name.className = "item-name";
        name.textContent = it.name;

        const qty = document.createElement("div");
        qty.className = "item-qty";
        qty.textContent = "x " + it.qty;

        info.appendChild(name);
        info.appendChild(qty);

        left.appendChild(cb);
        left.appendChild(info);

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const chip = document.createElement("span");
        chip.className = "chip";
        chip.textContent = it.source || "MiniApp";

        const btnMinus = document.createElement("button");
        btnMinus.className = "btn-icon";
        btnMinus.textContent = "-";
        btnMinus.onclick = () => cambiarCantidad(index, -1);

        const btnPlus = document.createElement("button");
        btnPlus.className = "btn-icon";
        btnPlus.textContent = "+";
        btnPlus.onclick = () => cambiarCantidad(index, 1);

        const btnDel = document.createElement("button");
        btnDel.className = "btn-icon";
        btnDel.textContent = "Ã—";
        btnDel.onclick = () => eliminarItem(index);

        actions.appendChild(chip);
        actions.appendChild(btnMinus);
        actions.appendChild(btnPlus);
        actions.appendChild(btnDel);

        div.appendChild(left);
        div.appendChild(actions);
        cont.appendChild(div);
      });

      document.getElementById("lblResumen").textContent = hechos + "/" + total + " comprados";
    }

    // =========================
    // SERVER CALLS (D1)
    // =========================
   async function cargarListaDesdeServidor() {
  try {
    const uid = init?.user?.id || 0;
    log(`INIT userId=${uid}`);

    log(`SCOPE scope=${scope} scopeId=${scopeId}`);

    if (!uid) {
      log("ERROR: no hay userId (no es WebApp real).");
      items = [];
      renderLista();
      return;
    }

    const cacheBust = Date.now().toString();
    const u = new URL(`${API_BASE}/lista`, window.location.origin);
    u.searchParams.set("scope", scope);
    u.searchParams.set("scopeId", scopeId);
    u.searchParams.set("_", cacheBust);

    log(`GET ${u.toString()}`);

    const res = await fetch(u.toString(), { method: "GET", cache: "no-store" });
    log(`RES status=${res.status}`);

    if (!res.ok) {
      const t = await safeText(res);
      log(`RES body=${t.slice(0, 400)}`);
      items = [];
      renderLista();
      return;
    }

    const data = await res.json().catch(async () => {
      const t = await safeText(res);
      log("JSON parse error. Body=" + t.slice(0, 400));
      return null;
    });

    log(`JSON ok. items=${Array.isArray(data) ? data.length : "no-array"}`);

    items = (data || []).map(r => ({
      id: r.id,
      name: r.name,
      qty: Number(r.qty || 1),
      done: !!r.done,
      source: r.source || "MiniApp"
    }));

    renderLista();
    log("renderLista() OK");
  } catch (e) {
    log("EX: " + (e?.message || e));
    items = [];
    renderLista();
  }
}

    

    async function enviarCambioAlServidor(tipo, nombre, extra) {
      if (!userId) return;

      const payload = {
        userId: String(userId),
        tipo: tipo,
        nombre: nombre,
        extra: (extra != null ? String(extra) : null),
        scope: scope,
        scopeId: String(scopeId),
        source: "MiniApp"
      };

      try {
        const res = await fetch(API_BASE + "/sync", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const t = await res.text().catch(() => "");
          setDebug(document.getElementById("debug").textContent + "\nSYNC ERROR " + res.status + " " + t);
        }
      } catch (e) {
        setDebug(document.getElementById("debug").textContent + "\nSYNC EX: " + (e && e.message ? e.message : e));
      }
    }

    // =========================
    // ACTIONS
    // =========================
    function agregarItemDesdeInput() {
      const input = document.getElementById("inputProducto");
      const valor = (input.value || "").trim();
      if (!valor) return;

      items.push({ name: valor, qty: 1, done: false, source: "MiniApp" });
      input.value = "";
      renderLista();
      enviarCambioAlServidor("add", valor, null);
    }

    function cambiarCantidad(idx, delta) {
      const it = items[idx];
      if (!it) return;
      it.qty = Math.max(1, (it.qty || 1) + delta);
      renderLista();
      enviarCambioAlServidor("qty", it.name, it.qty);
    }

    function toggleItem(idx) {
      const it = items[idx];
      if (!it) return;
      it.done = !it.done;
      renderLista();
      enviarCambioAlServidor("toggle", it.name, it.done);
    }

    function eliminarItem(idx) {
      const it = items[idx];
      if (!it) return;
      const name = it.name;
      items.splice(idx, 1);
      renderLista();
      enviarCambioAlServidor("delete", name, null);
    }

    // =========================
    // WIRE EVENTS + START
    // =========================
    document.getElementById("btnAgregar").addEventListener("click", agregarItemDesdeInput);
    document.getElementById("inputProducto").addEventListener("keydown", (e) => {
      if (e.key === "Enter") agregarItemDesdeInput();
    });

    initTelegramUI();
    setTimeout(() => {
      cargarListaDesdeServidor();
    }, 150);
    setTimeout(cargarListaDesdeServidor, 200);
    setTimeout(cargarListaDesdeServidor, 900);
  </script>
</body>
</html>





















