<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>HonoShop â€“ Lista de compras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- SDK de Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
    }
    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: rgba(15,23,42,0.95);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
      border: 1px solid rgba(148,163,184,0.3);
    }
    h1 {
      margin: 0 0 4px;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    h1 span.logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px #22c55e;
    }
    .subtitle {
      margin: 0 0 12px;
      font-size: 13px;
      color: #9ca3af;
    }
    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .row input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      outline: none;
      font-size: 14px;
    }
    .row input::placeholder {
      color: #6b7280;
    }
    .row button {
      border-radius: 999px;
      padding: 8px 14px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: white;
      box-shadow: 0 6px 14px rgba(22,163,74,0.45);
      transition: transform 0.07s ease, box-shadow 0.07s ease;
    }
    .row button:active {
      transform: translateY(1px);
      box-shadow: 0 3px 8px rgba(22,163,74,0.35);
    }
    .list {
      margin-top: 8px;
      max-height: 360px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(55,65,81,0.8);
      margin-bottom: 6px;
      font-size: 14px;
    }
    .item-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }
    .item-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .item-qty {
      font-size: 12px;
      color: #9ca3af;
    }
    .item.done {
      opacity: 0.6;
      text-decoration: line-through;
    }
    .chip {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      color: #9ca3af;
    }
    .item-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: 8px;
    }
    .btn-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      border: 1px solid rgba(75,85,99,0.9);
      transition: background 0.07s ease, transform 0.07s ease;
    }
    .btn-icon:active {
      transform: translateY(1px);
      background: rgba(30,64,175,0.9);
    }
    .footer-text {
      margin-top: 10px;
      font-size: 11px;
      color: #6b7280;
      text-align: right;
    }
    .pill-bar {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 11px;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>
        <span class="logo-dot"></span>
        HonoShop
      </h1>
      <p class="subtitle">Tu lista de compras conectada al bot de Telegram ðŸ›’</p>

      <div class="row">
        <input id="inputProducto" type="text" placeholder="Ej: leche, pan, detergente..." />
        <button id="btnAgregar" type="button">Agregar</button>
        
      </div>

      <div class="pill-bar">
        <span id="lblUsuario"></span>
        <span id="lblResumen"></span>
      </div>

      <div id="lista" class="list"></div>

      <div class="footer-text">
        Los cambios se sincronizan con tu chat del bot.
      </div>
      <div id="debug"></div>
    </div>
  </div>

  
<script>
  const tg = window.Telegram?.WebApp;
  tg?.ready();
  tg?.expand();

  const init = tg?.initDataUnsafe || {};
</script>

  <script>

    const url = new URL(`${API_BASE}/lista`, window.location.origin);
    //const API_BASE = "/api/shopping";
    //const API_BASE = "http://186.122.179.5:5005/api/shopping";
    //const API_BASE = "http://localhost:5005/api/shopping";

    // Estado local de ejemplo (idealmente esto vendrÃ¡ de tu API)
    let items = [];

    // InicializaciÃ³n de Telegram WebApp
    function initTelegram() {
      if (!tg) return;

      tg.ready();
      tg.expand();

      // Tema oscuro/claro segÃºn Telegram
      document.body.style.backgroundColor = tg.themeParams?.bg_color || '#0f172a';

      const userName = tg.initDataUnsafe?.user?.first_name || 'Usuario';
      document.getElementById('lblUsuario').innerText = `Hola, ${userName}`;

      // BotÃ³n principal de Telegram (parte inferior)
      tg.MainButton.setText("Cerrar HonoShop");
      tg.MainButton.onClick(() => tg.close());
      tg.MainButton.show();
    }

    function renderLista() {
      const cont = document.getElementById('lista');
      cont.innerHTML = '';

      if (items.length === 0) {
        cont.innerHTML = '<p style="font-size:13px;color:#6b7280;margin-top:4px;">TodavÃ­a no agregaste productos.</p>';
        document.getElementById('lblResumen').innerText = '';
        return;
      }

      let total = 0;
      let hechos = 0;

      items.forEach((it, index) => {
        total++;
        if (it.done) hechos++;

        const div = document.createElement('div');
        div.className = 'item' + (it.done ? ' done' : '');

        const left = document.createElement('div');
        left.className = 'item-left';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = it.done;
        cb.onchange = () => toggleItem(index);

        const info = document.createElement('div');
        const name = document.createElement('div');
        name.className = 'item-name';
        name.textContent = it.name;

        const qty = document.createElement('div');
        qty.className = 'item-qty';
        qty.textContent = 'x ' + it.qty;

        info.appendChild(name);
        info.appendChild(qty);

        left.appendChild(cb);
        left.appendChild(info);

        const actions = document.createElement('div');
        actions.className = 'item-actions';

        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = it.source || 'MiniApp';

        const btnMinus = document.createElement('button');
        btnMinus.className = 'btn-icon';
        btnMinus.textContent = '-';
        btnMinus.onclick = () => cambiarCantidad(index, -1);

        const btnPlus = document.createElement('button');
        btnPlus.className = 'btn-icon';
        btnPlus.textContent = '+';
        btnPlus.onclick = () => cambiarCantidad(index, 1);

        const btnDel = document.createElement('button');
        btnDel.className = 'btn-icon';
        btnDel.textContent = 'Ã—';
        btnDel.onclick = () => eliminarItem(index);

        actions.appendChild(chip);
        actions.appendChild(btnMinus);
        actions.appendChild(btnPlus);
        actions.appendChild(btnDel);

        div.appendChild(left);
        div.appendChild(actions);

        cont.appendChild(div);
      });

      document.getElementById('lblResumen').innerText = `${hechos}/${total} comprados`;
    }

    function agregarItemDesdeInput() {
      const input = document.getElementById('inputProducto');
      const valor = (input.value || '').trim();
      if (!valor) return;

      // PodÃ©s parsear cantidades si querÃ©s ("2 leche" -> qty=2, name="leche")
      items.push({
        name: valor,
        qty: 1,
        done: false,
        source: 'MiniApp'
      });

      input.value = '';
      renderLista();
      enviarCambioAlServidor('add', valor);
    }

    function cambiarCantidad(idx, delta) {
      const it = items[idx];
      if (!it) return;
      it.qty = Math.max(1, (it.qty || 1) + delta);
      renderLista();
      enviarCambioAlServidor('qty', it.name, it.qty);
    }

    function toggleItem(idx) {
      const it = items[idx];
      if (!it) return;
      it.done = !it.done;
      renderLista();
      enviarCambioAlServidor('toggle', it.name, it.done);
    }

    function eliminarItem(idx) {
      const it = items[idx];
      if (!it) return;
      const name = it.name;
      items.splice(idx, 1);
      renderLista();
      enviarCambioAlServidor('delete', name);
    }

    // TODO: conectarlo con tu servidor real
    async function cargarListaDesdeServidor() {
  try {
    const tg = window.Telegram?.WebApp;
    const initLocal = tg?.initDataUnsafe || {};

    const chatId = initLocal.chat?.id || 0;
    const userId = initLocal.user?.id || 0;

    document.getElementById("debug").innerText = `chatId=${chatId} userId=${userId}`;

    if (!userId) {
      document.getElementById("debug").innerText += "\nERROR: no hay userId";
      items = [];
      renderLista();
      return;
    }

    const url = new URL(`${API_BASE}/lista`);
    url.searchParams.set("userId", userId);
    if (chatId) url.searchParams.set("chatId", chatId);

    const res = await fetch(url.toString());

    if (!res.ok) {
      document.getElementById("debug").innerText += `\nGET status=${res.status}`;
      items = [];
    } else {
      const data = await res.json();

      // OJO: tu API devuelve Name/Qty/Done/Source (mayÃºsculas)
      items = (data || []).map(it => ({
        name: it.name ?? it.Name,
        qty:  it.qty  ?? it.Qty,
        done: it.done ?? it.Done,
        source: (it.source ?? it.Source) || "Bot"
      }));
    }
  } catch (e) {
    document.getElementById("debug").innerText += `\nEX: ${e?.message || e}`;
    items = [];
  }

  renderLista();
}

 async function enviarCambioAlServidor(tipo, nombre, extra) {
  try {
    const chatId = init.chat?.id || null;
    const userId = init.user?.id || null;

    if (!userId) {
      console.warn("No hay userId; no se puede sincronizar.");
      return;
    }

    const payload = {
      userId: userId,
      chatId: chatId || 0,
      tipo: tipo,
      nombre: nombre,
      extra: extra != null ? String(extra) : null
    };

    await fetch(`${API_BASE}/sync`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
  } catch (e) {
    console.error("Error enviando cambios al servidor:", e);
  }
}

    document.getElementById('btnAgregar').addEventListener('click', agregarItemDesdeInput);
    document.getElementById('inputProducto').addEventListener('keydown', e => {
      if (e.key === 'Enter') agregarItemDesdeInput();
    });

    initTelegram();
    cargarListaDesdeServidor();
  </script>
  
</body>

</html>






