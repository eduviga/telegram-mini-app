<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>HonoShop â€“ Lista de compras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- SDK de Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <link rel="manifest" href="manifest.json">
  
  <style>
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal.hidden {
  display: none;
}

.modal-box {
  background: #0f172a;
  color: #e5e7eb;
  border-radius: 16px;
  padding: 20px;
  max-width: 320px;
  width: 90%;
  box-shadow: 0 20px 40px rgba(0,0,0,0.5);
  text-align: center;
}

.modal-box h2 {
  margin-top: 0;
  font-size: 18px;
}

.modal-box p {
  font-size: 14px;
  color: #cbd5f5;
  white-space: pre-line;
}

.select-lista {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;

  background: rgba(15,23,42,0.9);
  color: #e5e7eb;

  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.4);

  padding: 8px 36px 8px 14px;
  font-size: 14px;
  font-weight: 500;

  background-image: url("data:image/svg+xml;utf8,<svg fill='white' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;
  background-position: right 10px center;
}
    
.modal-box button {
  margin-top: 16px;
  padding: 8px 16px;
  border-radius: 999px;
  border: none;
  background: #22c55e;
  color: #052e16;
  font-size: 14px;
  cursor: pointer;
}
    
    :root { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: #0f172a; color: #e5e7eb; }
    .app { max-width: 480px; margin: 0 auto; padding: 16px; }
    .card {
      background: rgba(15,23,42,0.95);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
      border: 1px solid rgba(148,163,184,0.3);
    }
    h1 {
      margin: 0 0 4px;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between; /* ðŸ‘ˆ ESTA ES LA CLAVE */
    }
    h1 span.logo-dot { width:10px; height:10px; border-radius:999px; background:#22c55e; box-shadow:0 0 10px #22c55e; }
    .subtitle { margin: 0 0 12px; font-size: 13px; color: #9ca3af; }
    .row { display:flex; gap:8px; margin-bottom:10px; }
    .row input {
      flex:1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      outline: none;
      font-size: 14px;
    }
    .row input::placeholder { color:#6b7280; }
    .row button {
      border-radius: 999px;
      padding: 8px 14px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color: white;
      box-shadow: 0 6px 14px rgba(22,163,74,0.45);
      transition: transform 0.07s ease, box-shadow 0.07s ease;
    }
    .row button:active { transform: translateY(1px); box-shadow: 0 3px 8px rgba(22,163,74,0.35); }
    .pill-bar { display:flex; justify-content:space-between; margin-top:6px; font-size:11px; color:#9ca3af; }
    .list { margin-top: 8px; max-height: 360px; overflow-y:auto; padding-right:4px; }
    .item {
      display:flex; align-items:center; justify-content:space-between;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(55,65,81,0.8);
      margin-bottom: 6px;
      font-size: 14px;
    }
    .item-left { display:flex; align-items:center; gap:8px; flex:1; min-width:0; }
    .item-name { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item-qty { font-size:12px; color:#9ca3af; }
    .item.done { opacity:0.6; text-decoration: line-through; }
    .chip { font-size:11px; padding: 2px 8px; border-radius:999px; border:1px solid rgba(148,163,184,0.5); color:#9ca3af; }
    .item-actions { display:flex; align-items:center; gap:6px; margin-left:8px; }
    .btn-icon {
  width:42px;
  height:42px;
  border-radius:999px;
  border:none;
  cursor:pointer;

  display:flex;
  align-items:center;
  justify-content:center;

  font-size:22px;
  font-weight:bold;

  background: rgba(15,23,42,0.95);
  color:#e5e7eb;
  border: 1px solid rgba(75,85,99,0.9);

  transition: background 0.07s ease, transform 0.07s ease;
}
    .btn-icon:active { transform: translateY(1px); background: rgba(30,64,175,0.9); }
    .footer-text { margin-top: 10px; font-size: 11px; color: #6b7280; text-align:right; }
    #debug {
      margin-top: 10px;
      font-size: 11px;
      color: #93c5fd;
      white-space: pre-wrap;
      opacity: 0.9;
    }

    #btnEliminarLista {
  color: #ef4444;
  border-color: rgba(239,68,68,0.6);
}

#btnEliminarLista:active {
  background: rgba(127,29,29,0.9);
}

#btnEditarLista {
  color: #60a5fa;
  border-color: rgba(96,165,250,0.6);
}

 /* BOTÃ“N EDITAR LISTA */
#btnEditarLista {
  color: #0f172a;              /* azul oscuro / casi negro */
  background: #e5e7eb;         /* gris claro */
  border-color: rgba(15,23,42,0.6);
}

/* Feedback al tocar */
#btnEditarLista:active {
  background: #cbd5e1;
}   

  
  </style>


</head>

  <div id="modalAyuda" class="modal hidden">
  <div class="modal-box">
    <h2>Ayuda Â· HonoShop</h2>
    <p id="modalTexto"></p>
    <button id="btnCerrarModal">Entendido</button>
  </div>
</div>

<div id="modalLista" class="modal hidden">
  <div class="modal-box">
    <h2 id="tituloModalLista">Agregar lista</h2>

    <input
      id="inputNombreLista"
      type="text"
      placeholder="Ej: FerreterÃ­a"
      style="
        width:100%;
        padding:10px;
        border-radius:10px;
        border:1px solid #334155;
        background:#020617;
        color:#e5e7eb;
        margin-top:8px;
      "
    />

    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
      <button id="btnCancelarLista" style="background:#334155;color:#e5e7eb;">Cancelar</button>
      <button id="btnAceptarLista">Aceptar</button>
    </div>
  </div>
</div>  

  <div id="modalEliminarLista" class="modal hidden">
  <div class="modal-box">
    <h2>Eliminar lista</h2>

    <p id="textoEliminarLista"></p>

    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:16px;">
      <button id="btnCancelarEliminar" style="background:#334155;color:#e5e7eb;">
        Cancelar
      </button>
      <button id="btnConfirmarEliminar" style="background:#dc2626;color:white;">
        Eliminar
      </button>
    </div>
  </div>
</div>

<body>
  
  
  <div class="app">
    <div class="card">
      <h1><span class="logo-dot"></span>HonoShop
      <button id="btnAyuda" class="btn-ayuda">Ayuda</button>
      </h1>
      <p class="subtitle">Tu lista a mano</p>

      <div class="row" style="align-items:center;">
  <select id="selectLista" class="select-lista" style="flex:1;">
    <option value="General">General</option>
  </select>

  <!-- Agregar -->
  <button id="btnNuevaLista" type="button" class="btn-icon" title="Agregar lista">
    ï¼‹
  </button>

  <!-- Editar -->
  <button id="btnEditarLista" type="button" class="btn-icon" title="Renombrar lista">
    <svg width="18" height="18" viewBox="0 0 24 24"
         fill="none" stroke="currentColor" stroke-width="2"
         stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 20h9"></path>
      <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
    </svg>
 </button>

  <!-- Eliminar -->
  <button id="btnEliminarLista" type="button" class="btn-icon" title="Eliminar lista">
  <svg width="18" height="18" viewBox="0 0 24 24"
       fill="none" stroke="currentColor" stroke-width="2"
       stroke-linecap="round" stroke-linejoin="round">
    <polyline points="3 6 5 6 21 6"></polyline>
    <path d="M19 6l-1 14H6L5 6"></path>
    <path d="M10 11v6"></path>
    <path d="M14 11v6"></path>
    <path d="M9 6V4h6v2"></path>
  </svg>
</button>
</div>

      

      <div class="row">
        <input id="inputProducto" type="text" placeholder="Ej: leche, pan, detergente..." />
        <button id="btnAgregar" type="button">Agregar</button>
      </div>

      <div class="pill-bar">
        <span id="lblUsuario"></span>
        <span id="lblResumen"></span>
      </div>

      <div id="lista" class="list"></div>

      <pre id="log" style="margin-top:10px;padding:10px;border-radius:12px;background:rgba(0,0,0,0.35);color:#93c5fd;font-size:12px;white-space:pre-wrap;max-height:200px;overflow:auto;"></pre>
     
      <div class="footer-text">Los cambios se sincronizan con tu chat del bot.</div>
      <div id="debug"></div>
    </div>
  </div>

 <script>
/* =========================
   CONFIG + UTILIDADES
========================= */
const API_BASE = "/api/shopping";

function safeText(res) {
  try { return res.text(); } catch { return ""; }
}

function getWebUserId() {
  let id = localStorage.getItem("honoshop_user");
  if (!id) {
    id = crypto.randomUUID();
    localStorage.setItem("honoshop_user", id);
  }
  return id;
}

/* =========================
   TELEGRAM INIT
========================= */
const tg = window.Telegram?.WebApp || null;
if (tg) { try { tg.ready(); } catch {} }

const init = tg?.initDataUnsafe || {};
const userId = init?.user?.id || getWebUserId();
const userName = init?.user?.first_name || "";

let scope = "user";
let scopeId = String(userId);

/* =========================
   LISTAS
========================= */
let listas = [];
let currentList = "General";
let items = [];

function cargarListas() {
  const guardadas = JSON.parse(localStorage.getItem("honoshop_listas") || "[]");
  listas = guardadas.length ? guardadas : ["General"];
  if (!listas.includes("General")) listas.unshift("General");

  const select = document.getElementById("selectLista");
  select.innerHTML = "";

  listas.forEach(l => {
    const opt = document.createElement("option");
    opt.value = l;
    opt.textContent = l;
    select.appendChild(opt);
  });

  const last = localStorage.getItem("honoshop_lista_actual");
  currentList = listas.includes(last) ? last : "General";
  select.value = currentList;
}

/* =========================
   UI
========================= */
function renderLista() {
  const cont = document.getElementById("lista");
  cont.innerHTML = "";

  if (!items.length) {
    cont.innerHTML = `<p style="font-size:13px;color:#6b7280">TodavÃ­a no agregaste productos.</p>`;
    return;
  }

  items.forEach((it, i) => {
    const div = document.createElement("div");
    div.className = "item" + (it.done ? " done" : "");
    div.innerHTML = `
      <div class="item-left">
        <input type="checkbox" ${it.done ? "checked" : ""}/>
        <div>
          <div class="item-name">${it.name}</div>
          <div class="item-qty">x ${it.qty}</div>
        </div>
      </div>
      <div class="item-actions">
        <button class="btn-icon">-</button>
        <button class="btn-icon">+</button>
        <button class="btn-icon">Ã—</button>
      </div>
    `;
    cont.appendChild(div);
  });
}

/* =========================
   SERVER
========================= */
async function cargarListaDesdeServidor() {
  const url = new URL(API_BASE + "/lista", location.origin);
  url.searchParams.set("scope", scope);
  url.searchParams.set("scopeId", scopeId);
  url.searchParams.set("list", currentList);

  const res = await fetch(url);
  if (!res.ok) return;

  const data = await res.json();
  items = data || [];
  renderLista();
}

async function enviarCambio(tipo, nombre, extra=null) {
  await fetch(API_BASE + "/sync", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      userId,
      tipo,
      nombre,
      extra,
      scope,
      scopeId,
      list: currentList,
      source: init?.user ? "MiniApp" : "Web"
    })
  });
}

/* =========================
   MODAL LISTA (ÃšNICO)
========================= */
const modalLista = document.getElementById("modalLista");
const inputNombreLista = document.getElementById("inputNombreLista");
const btnCancelarLista = document.getElementById("btnCancelarLista");
const btnAceptarLista = document.getElementById("btnAceptarLista");
const tituloModalLista = document.getElementById("tituloModalLista");
const btnEditarLista = document.getElementById("btnEditarLista");   

let modoLista = "crear";
let listaOriginal = null;

btnNuevaLista.addEventListener("click", () => {
  modoLista = "crear";
  listaOriginal = null;

  tituloModalLista.textContent = "Agregar lista";
  inputNombreLista.value = "";

  modalLista.classList.remove("hidden");
  inputNombreLista.focus();
});

btnCancelarLista.addEventListener("click", () => {
  modalLista.classList.add("hidden");
  inputNombreLista.value = "";
});


btnEditarLista.addEventListener("click", () => {
  abrirRenombrarLista();
});   

btnAceptarLista.addEventListener("click", () => {
  const nombre = inputNombreLista.value.trim();
  if (!nombre) return;

  // Evitar duplicados
  if (listas.includes(nombre)) {
    alert("Ya existe una lista con ese nombre");
    return;
  }

  if (modoLista === "crear") {
    listas.push(nombre);
    localStorage.setItem("honoshop_lista_actual", nombre);

  } else if (modoLista === "renombrar") {
    const index = listas.indexOf(listaOriginal);
    if (index === -1) return;

    listas[index] = nombre;

    // actualizar lista actual si corresponde
    if (currentList === listaOriginal) {
      localStorage.setItem("honoshop_lista_actual", nombre);
    }
  }

  localStorage.setItem("honoshop_listas", JSON.stringify(listas));

  modalLista.classList.add("hidden");
  inputNombreLista.value = "";

  cargarListas();
  cargarListaDesdeServidor();
});

   btnEliminarLista.addEventListener("click", () => {
  if (currentList === "General") {
    alert("La lista General no se puede eliminar");
    return;
  }

  if (listas.length <= 1) {
    alert("Debe existir al menos una lista");
    return;
  }

  const ok = confirm(
    `Â¿Eliminar la lista "${currentList}"?\n\nSe borrarÃ¡n todos sus Ã­tems.`
  );

  if (!ok) return;

  listas = listas.filter(l => l !== currentList);
  localStorage.setItem("honoshop_listas", JSON.stringify(listas));

  currentList = "General";
  localStorage.setItem("honoshop_lista_actual", currentList);

  cargarListas();
  cargarListaDesdeServidor();
});

   function abrirRenombrarLista() {
  if (currentList === "General") {
    alert("La lista General no se puede renombrar");
    return;
  }

  modoLista = "renombrar";
  listaOriginal = currentList;

  tituloModalLista.textContent = "Renombrar lista";
  inputNombreLista.value = currentList;

  modalLista.classList.remove("hidden");
  inputNombreLista.focus();
}

/* =========================
   START
========================= */
window.addEventListener("load", () => {
  if (userName) document.getElementById("lblUsuario").textContent = "Hola, " + userName;

  cargarListas();
  cargarListaDesdeServidor();

  document.getElementById("selectLista").addEventListener("change", e => {
    currentList = e.target.value;
    localStorage.setItem("honoshop_lista_actual", currentList);
    cargarListaDesdeServidor();
  });
});
</script>
  
</body>
</html>




















































































